let user,room,key,chat;const colors=["#efc4c4","#efd2c4","#efe1c4","#efefc4","#e1efc4","#d2efc4","#c4efc4","#c4efd2","#c4efe1","#c4efef","#c4e1ef","#c4d2ef","#c4c4ef","#d2c4ef","#e1c4ef","#efc4ef","#efc4e1","#efc4d2"],hide=function(n){const t=$(`#${n}`);t.addClass("display-none");t.removeClass("flex")},show=function(n){const t=$(`#${n}`);t.removeClass("display-none");t.addClass("flex")},replaceClass=function(n,t,i){const r=$(`#${n}`);r.removeClass(t);r.addClass(i)},showTooltipIf=function(n,t,i,r){const f=$(`#${n}`),u=$(`#${t}`);i(f,r)?(u.tooltip("show"),setTimeout(function(){u.tooltip("hide")},1e3)):u.tooltip("hide")},removeTooltip=function(n){n.tooltip("dispose")},removePopover=function(n){n.popover("dispose")},inputfieldToFailedStateIf=function(n,t,i,r){i($(`#${n}`),r)?(replaceClass(t,"has-success","has-danger"),replaceClass(n,"form-control-success","form-control-danger")):(replaceClass(t,"has-danger","has-success"),replaceClass(n,"form-control-danger","form-control-success"))},isValueEmpty=function(n,t=true){return t?n.val().trim()==="":n.val()===""},nextColor=function(n){return colors.indexOf(n)+1===colors.length?colors[0]:colors[colors.indexOf(n)+1]},UserInterface={initialize:function(){$.connection.hub.stateChanged(handleConnectionStateChanged);$("#txtUsername").focus();$("#btnSendMessage").click(UserInterface.onBtnSendMessageClick);$("#btnApplySettings").click(UserInterface.onBtnJoinClick);$("#btnShowHideUserList").click(UserInterface.onBtnShowHideUserListClick);$("#btnRandomPassword").click(UserInterface.onBtnGeneratePasswordClick);$("#btnShowHidePassword").click(UserInterface.onBtnShowHidePasswordClick);$("#btnLeaveRoom").click(UserInterface.onBtnLeaveRoomClicked);$("#btnLeaveRoomApproved").click(UserInterface.onBtnLeaveRoomApprovedClicked);$("#btnLeaveRoomDenied").click(UserInterface.onBtnLeaveRoomDeniedClicked);$("#btnErrorOk").click(UserInterface.onBtnErrorOkClicked);$("#btnSettings").click(UserInterface.onBtnSettingsClicked);$("#btnCancelSettings").click(UserInterface.onBtnCancelSettingsClicked);$("#txtMessage").keyup(UserInterface.onTxtMessageKeyUp);$("#txtMessage").keydown(UserInterface.onTxtMessageKeyDown);$("#txtMessage").blur(UserInterface.onTxtMessageBlur);$("#divChat").scroll(UserInterface.updateBtnScrollDown);$("#btnScrollDown").click(UserInterface.scrollChatDown);const n=$("#txtPassword"),t=$("#txtRoom"),i=$("#txtUsername");n.keyup(UserInterface.onTxtPasswordKeyUp);n.blur(UserInterface.onTxtPasswordKeyUp);t.keyup(UserInterface.onTxtRoomKeyUp);t.blur(UserInterface.onTxtRoomKeyUp);i.keyup(UserInterface.onTxtUsernameKeyUp);i.blur(UserInterface.onTxtUsernameKeyUp);const r=[[$("#rowPassword"),"Input cannot be empty","top","manual",0],[$("#rowRoom"),"Input cannot be empty","top","manual",0],[$("#rowUsername"),"Input cannot be empty","top","manual",0],[$("#btnRandomPassword"),"Generate a new random password","left","hover",500],[$("#btnCopyPassword"),"Copy password to clipboard","left","hover",500],[$("#btnShowHidePassword"),"Show/Hide password","left","hover",500],[$("#btnShowHideUserList"),"Show/Hide users","right","hover",500],[$("#btnLeaveRoom"),"Leave room","right","hover",500],[$("#btnSettings"),"Settings","right","hover",500]];r.forEach(function(n){removeTooltip(n[0]);n[0].tooltip({title:n[1],placement:function(){return $(window).width()<975?n[2]:"right"},trigger:n[3],delay:{show:n[4]}})});const u=new Clipboard("#btnCopyPassword",{text:function(){return $("#txtPassword").val()}});hide("divSplashscreen")},activeKeys:[],onTxtMessageKeyUp:function(n){const t=[];UserInterface.activeKeys.forEach(function(n,i){n&&t.push(i)});UserInterface.activeKeys[n.keyCode]=!1;t.length===1&&t[0]===13&&UserInterface.onBtnSendMessageClick()},onTxtMessageKeyDown:function(n){UserInterface.activeKeys[n.keyCode]=!0},onTxtMessageBlur:function(){UserInterface.activeKeys.forEach(function(n,t){UserInterface.activeKeys[t]=!1})},onBtnSettingsClicked:function(){hide("rowPassword");hide("rowPasswordStrength");hide("rowRoom");const n=$("#btnApplySettings");n.text("Apply Changes");n.unbind("click");n.click(UserInterface.onBtnApplyClicked);show("rowCancelSettings");setTimeout(function(){show("divSettings")},200)},scrollChatDown:function(){const n=$("#divChat");n.animate({scrollTop:n.prop("scrollHeight")},500);UserInterface.updateBtnScrollDown()},updateBtnScrollDown:function(){setTimeout(function(){const n=$("#divChat");n.scrollTop()+n.innerHeight()>=n[0].scrollHeight?hide("btnScrollDown"):show("btnScrollDown")},500)},onBtnApplyClicked:function(){let n=$("#txtUsername").val().trim();n=encrypt(n,DEFAULT_IV);user=n.ciphertext.toString(CryptoJS.enc.Base64);Caller.init(user,room);UserInterface.onBtnCancelSettingsClicked()},onBtnErrorOkClicked:function(){hide("divError")},onBtnCancelSettingsClicked:function(){hide("divSettings");setTimeout(function(){show("rowPassword");show("rowPasswordStrength");show("rowRoom");const n=$("#btnApplySettings");n.text("Join");n.unbind("click");n.click(UserInterface.onBtnJoinClick);hide("rowCancelSettings")},200)},onBtnLeaveRoomClicked:function(){show("divLeaveRoom")},onBtnLeaveRoomApprovedClicked:function(){Caller.init(null,null);hide("divLeaveRoom");hide("divContent");hide("rowCancelSettings");show("divSettings");$("#divChat").empty();window.user=null;window.key=null;window.room=null},onBtnLeaveRoomDeniedClicked:function(){hide("divLeaveRoom")},onTxtPasswordKeyUp:function(n){UserInterface.updatePasswordField();UserInterface.updateInputField("Password",!1);null!=n&&13===n.keyCode&&UserInterface.onBtnJoinClick()},onBtnGeneratePasswordClick:function(){const n=Math.random().toString(36).slice(2),t=Math.random().toString(36).slice(2),i=n+t;$("#txtPassword").val(i);UserInterface.onTxtPasswordKeyUp(null)},onBtnShowHidePasswordClick:function(){const n=$("#txtPassword");n.attr("type")==="text"?(n.attr("type","password"),replaceClass("icoShowHide","fa-eye-slash","fa-eye")):(n.attr("type","text"),replaceClass("icoShowHide","fa-eye","fa-eye-slash"))},onTxtRoomKeyUp:function(n){UserInterface.updateInputField("Room");null!=n&&13===n.keyCode&&$("#txtPassword").focus()},onTxtUsernameKeyUp:function(n){UserInterface.updateInputField("Username");null!=n&&13===n.keyCode&&$("#txtRoom").focus()},onBtnSendMessageClick:function(){let n=$("#txtMessage").val().trim();if(n){const t=encrypt(n);n=t.ciphertext.toString(CryptoJS.enc.Base64);Caller.sendMessage(n,t.iv);$("#txtMessage").val("").focus()}},onBtnJoinClick:function(){if(UserInterface.updateJoinButtonState()){removePopover($("#divPwStrengthWrapper"));show("divKeyGeneration");$("#txtKeyGenerationAction").text("Generating Key...");let t=$("#txtPassword").val(),n=$("#txtRoom").val().trim(),i=$("#txtUsername").val().trim();if(t.length>128||n.length>128||i.length>24){hide("divKeyGeneration");handleError("Invalid input data");return}const r=new Worker("js/worker/keyworker.js");r.onmessage=function(r){const u=r.data||{};switch(u.type){case"status":UserInterface.updateProgressbar(Math.floor(u.value));break;case"done":key=JSON.parse(u.value);$("#txtKeyGenerationAction").text("Encrypting inputs...");t=CryptoJS.SHA3(t,{outputLength:512}).toString(CryptoJS.enc.Hex);n=CryptoJS.SHA3(n,{outputLength:512}).toString(CryptoJS.enc.Hex);i=encrypt(i,DEFAULT_IV);n=encrypt(t+n,DEFAULT_IV);user=i.ciphertext.toString(CryptoJS.enc.Base64);room=n.ciphertext.toString(CryptoJS.enc.Base64);$("#txtKeyGenerationAction").text("Initializing...");Caller.init(user,room)}};r.postMessage({cmd:"startKeyGeneration",param:{pass:t,room:n}})}},onBtnShowHideUserListClick:function(){$("#divUserList").is(":visible")?(hide("divUserList"),setTimeout(function(){replaceClass("divConversationWrapper","col-xl-9","col-xl-12");replaceClass("divConversationWrapper","col-lg-9","col-lg-12");replaceClass("divConversationWrapper","col-md-9","col-md-12")},200)):(show("divUserList"),replaceClass("divConversationWrapper","col-xl-12","col-xl-9"),replaceClass("divConversationWrapper","col-lg-12","col-lg-9"),replaceClass("divConversationWrapper","col-md-12","col-md-9"))},updatePasswordFieldTimeout:null,updatePasswordField:function(){const e=$("#txtPassword").val(),t=$("#divPwStrengthWrapper"),n=$("#pbPwStrength");if(n.removeClass("bg-success"),n.removeClass("bg-warning"),n.addClass("bg-danger"),n.width("1%"),e===""){removePopover(t);return}const i=window.zxcvbn(e);let r=i.score*25;if(1<r&&n.width(r+"%"),r>50&&r<76?(n.removeClass("bg-success"),n.removeClass("bg-danger"),n.addClass("bg-warning")):r>75&&(n.removeClass("bg-warning"),n.removeClass("bg-danger"),n.addClass("bg-success")),i.feedback.suggestions.length<=0){removePopover(t);return}let f=$("<div>");$(document).on("mouseover",f,function(){removePopover(t)});if(i.feedback.warning!==""){let n=$("<div>");n.addClass("alert alert-warning");f.append(n);let t=$("<b>");t.text("Warning");n.append(t);n.append($("<br>"));let r=$("<span>");r.text(i.feedback.warning);n.append(r)}let u=$("<div>");u.addClass("alert alert-info no-margin flex flex-column");f.append(u);let o=$("<b>");o.text("Suggestions");u.append(o);u.append($("<br>"));i.feedback.suggestions.forEach(function(n){const t=$("<span>");t.text(`â€¢ ${n}`);u.append(t)});removePopover(t);t.popover({animation:!0,html:!0,content:f.html(),placement:function(){return $(window).width()<875?"bottom":"right"}});clearTimeout(UserInterface.updatePasswordFieldTimeout);t.popover("show");UserInterface.updatePasswordFieldTimeout=setTimeout(function(){removePopover(t)},2e3)},updateInputField:function(n,t=true){showTooltipIf(`txt${n}`,`row${n}`,isValueEmpty,t);inputfieldToFailedStateIf(`txt${n}`,`row${n}`,isValueEmpty,t);UserInterface.updateJoinButtonState()},updateJoinButtonState:function(){const n=$("#btnApplySettings");return $("#txtPassword").val()===""||$("#txtRoom").val().trim()===""||$("#txtUsername").val().trim()===""?(n.addClass("disabled"),!1):(n.removeClass("disabled"),!0)},updateProgressbar:function(n){const t=$(".progress-pie-chart"),i=360*n/100;n>50?t.addClass("gt-50"):t.removeClass("gt-50");$(".ppc-progress-fill").css("transform",`rotate(${i}deg)`);$(".ppc-percents span").html(n+"%")}},Caller={sendMessage:function(n,t){chat.server.send(n,t)},init:function(n,t){chat.server.init(n,t)},requestUsersInRoom:function(){chat.server.requestUsers()}},handleGetMessage=function(n,t,i){const r=decrypt(n,DEFAULT_IV),u=decrypt(t,i);n=r.toString(CryptoJS.enc.Utf8);t=u.toString(CryptoJS.enc.Utf8);insertNewMessage(n,t)},insertNewMessage=function(n,t){t=filterXSS(t,{whiteList:[],stripIgnoreTag:!0,stripIgnoreTagBody:["script"],onTag:function(){return" **sanitized** "}});t=t.replace(/\n/g,"<br />");const i=$("<div>");i.css("min-width","100%");i.css("display","flex");i.css("margin-top","2px");i.addClass("flex-sm-column");i.addClass("flex-column");i.addClass("flex-md-row");const s=$("<span>");s.addClass("badge");s.css("background-color","rgba(0, 0, 0, .25)");s.text((new Date).toLocaleTimeString());i.append(s);const u=$("<strong>");u.addClass("margin-md-left-10");u.addClass("margin-md-right-5");u.css("word-wrap","break-word");u.css("display","inline-block");u.css("max-width","100%");u.text(`${n}:`);i.append(u);const f=$("<div>");f.css("word-wrap","break-word");f.css("word-break","break-all");f.css("display","inline-block");f.css("max-width","100%");f.html(t);i.append(f);let o=colors[0];const e=$("#divChat"),h=e.scrollTop()+e.innerHeight()>=e[0].scrollHeight;if(e.children().length!==0){const t=e.children().last();if(t.prop("cc:user")===n){t.append(i);h&&UserInterface.scrollChatDown();return}o=t.prop("cc:color")}const r=$("<div>");r.addClass("alert");o=nextColor(o);r.css("background-color",o);r.css("margin-bottom","2px");r.css("margin-top","2px");r.prop("cc:user",n);r.prop("cc:color",o);r.css("flex-direction","column");r.append(i);e.append(r);h&&UserInterface.scrollChatDown()},handleError=function(n){$("#txtErrorMessage").text(n);UserInterface.updateProgressbar(0);show("divError")},handleUserJoined=function(n){n=decrypt(n,DEFAULT_IV).toString(CryptoJS.enc.Utf8);insertNewMessage("System",`User '${n}' joined the room`);Caller.requestUsersInRoom()},handleUserLeft=function(n){n=decrypt(n,DEFAULT_IV).toString(CryptoJS.enc.Utf8);insertNewMessage("System",`User '${n}' left the room`);Caller.requestUsersInRoom()},handleInitRequest=function(){Caller.init(user,room)},handleUserRenamed=function(n,t){n=decrypt(n,DEFAULT_IV).toString(CryptoJS.enc.Utf8);t=decrypt(t,DEFAULT_IV).toString(CryptoJS.enc.Utf8);insertNewMessage("System",`User '${n}' changed name to '${t}'`);Caller.requestUsersInRoom()},handleConnectionStateChanged=function(n){switch(n.newState){case 0:handleConnecting();break;case 1:handleConnected();break;case 2:handleReconnecting();break;case 4:handleDisconnected()}},handleConnected=function(){hide("divReconnecting")},handleConnecting=function(){show("divReconnecting")},handleReconnecting=function(){show("divReconnecting")},handleDisconnected=function(){show("divReconnecting");$.connection.hub.start()},handleGetUsersInRoom=function(n){const i=$("#divUsers");i.empty();let t=colors[0];n.forEach(n=>{const r=$("<div>");r.addClass("alert");t=nextColor(t);r.css("background-color",t);r.css("margin-bottom","2px");r.css("margin-top","2px");r.addClass("margin-sm-left-5","2px");r.addClass("margin-sm-right-5","2px");r.text(decrypt(n,DEFAULT_IV).toString(CryptoJS.enc.Utf8));i.append(r)})},handleInitSuccess=function(){hide("divKeyGeneration");hide("divSettings");show("divContent");UserInterface.updateProgressbar(0);$("#txtMessage").focus()},handleInitFailed=function(n){hide("divKeyGeneration");show("divSettings");$("#txtErrorMessage").text(n);show("divError");setTimeout(function(){UserInterface.updateProgressbar(0)},200)},DEFAULT_IV=CryptoJS.lib.WordArray.create("r6Dolxzt2G/c7yEQlgRXy+FbvEy9IzsElLTpkvHnDns="),encrypt=function(n,t=null){if(null==key)throw"IllegalStateException";return null==t&&(t=CryptoJS.lib.WordArray.random(32)),CryptoJS.AES.encrypt(n,key,{mode:CryptoJS.mode.CTR,iv:t})},decrypt=function(n,t){if(null==key)throw"IllegalStateException";return CryptoJS.AES.decrypt(n,key,{mode:CryptoJS.mode.CTR,iv:t})};$(function(){chat=$.connection.cryptoChatHub;chat.client.getMessage=handleGetMessage;chat.client.error=handleError;chat.client.userJoined=handleUserJoined;chat.client.userLeft=handleUserLeft;chat.client.initRequest=handleInitRequest;chat.client.userRenamed=handleUserRenamed;chat.client.getUsersInRoom=handleGetUsersInRoom;chat.client.initSuccess=handleInitSuccess;chat.client.initFailed=handleInitFailed;$.connection.hub.start({waitForPageLoad:!0}).done(UserInterface.initialize)});